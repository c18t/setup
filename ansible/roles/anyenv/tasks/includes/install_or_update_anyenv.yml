---

- name: check anyenv
  shell: type anyenv
  args:
    executable: '{{ fish_path }}'
  register: type_anyenv
  failed_when: type_anyenv.rc not in [0, 1, 126, 127]
  changed_when: false
  check_mode: no

- block: # install anyenv
  - name: get anyenv
    shell: 'ghq get {{ anyenv_repository }} | grep -i anyenv'
    args:
      executable: '{{ fish_path }}'
    register: get_anyenv
    failed_when: get_anyenv.rc not in [0, 1]
    changed_when: get_anyenv.stdout is not search('exists')
  - include: includes/get_anyenv_source_path.yml
  - name: install anyenv
    file:
      state: link
      follow: no
      force: yes
      src:  '{{ anyenv_source_path }}'
      dest: '{{ home }}/.anyenv'
  when: type_anyenv.rc != 0

- block: # update anyenv
  - name: check anyenv update command
    shell: anyenv commands | grep -iq \\bupdate\\b
    args:
      executable: '{{ fish_path }}'
    register: check_anyenv_update
    failed_when: check_anyenv_update.rc not in [0, 1]
    changed_when: false
    check_mode: no
  - name: make anyenv-install config dir
    file:
      state: directory
      follow: yes
      path: '{{ xdg_config_home }}/anyenv/anyenv-install'
  - name: update anyenv
    shell: anyenv update
    args:
      executable: '{{ fish_path }}'
  when: type_anyenv.rc == 0
